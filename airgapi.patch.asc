-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA256

- From 64cd5b55d675ce6d82a848fc5e1aae08ed3fa4c6 Mon Sep 17 00:00:00 2001
From: GHIFARI160 <ghifari@ghifari160.com>
Date: Sun, 3 Oct 2021 21:08:16 -0500
Subject: Customize for AirGaPi

Remove networking firmware from stage2. This is an airgapped system. No
networking should be present on the hardware. As a safety measure, the
user should not be given the option to connect the system to the
network, even with the hardware present.

Remove SSH from stage2. SSH is not needed on an airgapped system.

Remove traditional stage3. Pi's stage 3 is traditionally the UI. There
is no need for a UI in this system at this stage.

Install GPG and smart card compatibility in stage3. GPG and smart card
is one of the core use case for an airgapped system.

Add YKMAN_TAG config variable to build.sh. YubiKey Manager version
should be configurable from the config.

Add prep_builder command to ykman install procedure. Duplicate the
RootFS dir as BuilderFS dir.

Add on_builder command to ykman install procedure. Chroot into BuilderFS
instead of RootFS.

Install YubiKey Manager dependencies and build tools in BuilderFS.
Prepare the environment to build YubiKey Manager without including them
in the final image.

Build and compile YubiKey Manager in BuilderFS. This allows YubiKey
Manager to be compiled to ARMHF arch on non-arm hosts.

Install YubiKey Manager to RootFS. Modification and management of
YubiKeys should be possible in an airgapped system.
- ---
 .gitignore                                    |  1 +
 build.sh                                      | 10 ++-
 stage2/01-sys-tweaks/00-packages              |  4 +-
 stage2/02-net-tweaks/00-packages              |  3 -
 stage2/02-net-tweaks/01-run.sh                | 36 --------
 stage2/02-net-tweaks/files/wait.conf          |  3 -
 .../02-net-tweaks/files/wpa_supplicant.conf   |  2 -
 stage3/00-gpg/00-packages                     |  1 +
 stage3/00-install-packages/00-debconf         |  2 -
 stage3/00-install-packages/00-packages        | 15 ----
 stage3/00-install-packages/00-packages-nr     |  6 --
 stage3/00-install-packages/01-run.sh          |  8 --
 stage3/01-smartcard/00-packages               |  2 +
 stage3/01-tweaks/00-run.sh                    |  3 -
 stage3/02-ykman/00-packages                   |  4 +
 stage3/02-ykman/02-run.sh                     | 84 +++++++++++++++++++
 stage3/02-ykman/files/common                  | 30 +++++++
 stage3/EXPORT_IMAGE                           |  4 +
 18 files changed, 133 insertions(+), 85 deletions(-)
 delete mode 100755 stage2/02-net-tweaks/01-run.sh
 delete mode 100644 stage2/02-net-tweaks/files/wait.conf
 delete mode 100644 stage2/02-net-tweaks/files/wpa_supplicant.conf
 create mode 100644 stage3/00-gpg/00-packages
 delete mode 100644 stage3/00-install-packages/00-debconf
 delete mode 100644 stage3/00-install-packages/00-packages
 delete mode 100644 stage3/00-install-packages/00-packages-nr
 delete mode 100755 stage3/00-install-packages/01-run.sh
 create mode 100644 stage3/01-smartcard/00-packages
 delete mode 100755 stage3/01-tweaks/00-run.sh
 create mode 100644 stage3/02-ykman/00-packages
 create mode 100755 stage3/02-ykman/02-run.sh
 create mode 100644 stage3/02-ykman/files/common
 create mode 100644 stage3/EXPORT_IMAGE

diff --git a/.gitignore b/.gitignore
index a6883c2..159a2cb 100644
- --- a/.gitignore
+++ b/.gitignore
@@ -7,3 +7,4 @@ SKIP_IMAGES
 .pc
 *-pc
 apt-cacher-ng/
+.DS_Store
diff --git a/build.sh b/build.sh
index ff008be..9c2c6f3 100755
- --- a/build.sh
+++ b/build.sh
@@ -99,7 +99,7 @@ run_stage(){
 	STAGE_WORK_DIR="${WORK_DIR}/${STAGE}"
 	ROOTFS_DIR="${STAGE_WORK_DIR}"/rootfs
 
- -	if [ "${USE_QCOW2}" = "1" ]; then 
+	if [ "${USE_QCOW2}" = "1" ]; then
 		if [ ! -f SKIP ]; then
 			load_qimage
 		fi
@@ -109,7 +109,7 @@ run_stage(){
 			unmount "${WORK_DIR}/${STAGE}"
 		fi
 	fi
- -	
+
 	if [ ! -f SKIP_IMAGES ]; then
 		if [ -f "${STAGE_DIR}/EXPORT_IMAGE" ]; then
 			EXPORT_DIRS="${EXPORT_DIRS} ${STAGE_DIR}"
@@ -133,7 +133,7 @@ run_stage(){
 		done
 	fi
 
- -	if [ "${USE_QCOW2}" = "1" ]; then 
+	if [ "${USE_QCOW2}" = "1" ]; then
 		unload_qimage
 	else
 		# make sure we are not umounting during export-image stage
@@ -229,6 +229,8 @@ export CLEAN
 export IMG_NAME
 export APT_PROXY
 
+export YKMAN_TAG
+
 export STAGE
 export STAGE_DIR
 export STAGE_WORK_DIR
@@ -369,7 +371,7 @@ for EXPORT_DIR in ${EXPORT_DIRS}; do
 
 	else
 		run_stage
- -	fi 
+	fi
 	if [ "${USE_QEMU}" != "1" ]; then
 		if [ -e "${EXPORT_DIR}/EXPORT_NOOBS" ]; then
 			# shellcheck source=/dev/null
diff --git a/stage2/01-sys-tweaks/00-packages b/stage2/01-sys-tweaks/00-packages
index a1f4b59..ed072cf 100644
- --- a/stage2/01-sys-tweaks/00-packages
+++ b/stage2/01-sys-tweaks/00-packages
@@ -1,10 +1,9 @@
- -ssh less fbset sudo psmisc strace ed ncdu crda
+less fbset sudo psmisc strace ed ncdu crda
 console-setup keyboard-configuration debconf-utils parted unzip
 build-essential manpages-dev python bash-completion gdb pkg-config
 python-rpi.gpio v4l-utils
 python-gpiozero
 python3-gpiozero
- -avahi-daemon
 lua5.1
 luajit
 hardlink ca-certificates curl
@@ -13,7 +12,6 @@ libraspberrypi-dev libraspberrypi-doc libfreetype6-dev
 dosfstools
 dphys-swapfile
 raspberrypi-sys-mods
- -pi-bluetooth
 apt-listchanges
 usb-modeswitch
 libpam-chksshpwd
diff --git a/stage2/02-net-tweaks/00-packages b/stage2/02-net-tweaks/00-packages
index cc4a68e..434335a 100644
- --- a/stage2/02-net-tweaks/00-packages
+++ b/stage2/02-net-tweaks/00-packages
@@ -1,4 +1 @@
- -wpasupplicant wireless-tools firmware-atheros firmware-brcm80211 firmware-libertas firmware-misc-nonfree firmware-realtek
- -raspberrypi-net-mods
- -dhcpcd5
 net-tools
diff --git a/stage2/02-net-tweaks/01-run.sh b/stage2/02-net-tweaks/01-run.sh
deleted file mode 100755
index d82381b..0000000
- --- a/stage2/02-net-tweaks/01-run.sh
+++ /dev/null
@@ -1,36 +0,0 @@
- -#!/bin/bash -e
- -
- -install -v -d					"${ROOTFS_DIR}/etc/systemd/system/dhcpcd.service.d"
- -install -v -m 644 files/wait.conf		"${ROOTFS_DIR}/etc/systemd/system/dhcpcd.service.d/"
- -
- -install -v -d					"${ROOTFS_DIR}/etc/wpa_supplicant"
- -install -v -m 600 files/wpa_supplicant.conf	"${ROOTFS_DIR}/etc/wpa_supplicant/"
- -
- -if [ -v WPA_COUNTRY ]; then
- -	echo "country=${WPA_COUNTRY}" >> "${ROOTFS_DIR}/etc/wpa_supplicant/wpa_supplicant.conf"
- -fi
- -
- -if [ -v WPA_ESSID ] && [ -v WPA_PASSWORD ]; then
- -on_chroot <<EOF
- -set -o pipefail
- -wpa_passphrase "${WPA_ESSID}" "${WPA_PASSWORD}" | tee -a "/etc/wpa_supplicant/wpa_supplicant.conf"
- -EOF
- -elif [ -v WPA_ESSID ]; then
- -cat >> "${ROOTFS_DIR}/etc/wpa_supplicant/wpa_supplicant.conf" << EOL
- -
- -network={
- -	ssid="${WPA_ESSID}"
- -	key_mgmt=NONE
- -}
- -EOL
- -fi
- -
- -# Disable wifi on 5GHz models if WPA_COUNTRY is not set
- -mkdir -p "${ROOTFS_DIR}/var/lib/systemd/rfkill/"
- -if [ -n "$WPA_COUNTRY" ]; then
- -    echo 0 > "${ROOTFS_DIR}/var/lib/systemd/rfkill/platform-3f300000.mmcnr:wlan"
- -    echo 0 > "${ROOTFS_DIR}/var/lib/systemd/rfkill/platform-fe300000.mmcnr:wlan"
- -else
- -    echo 1 > "${ROOTFS_DIR}/var/lib/systemd/rfkill/platform-3f300000.mmcnr:wlan"
- -    echo 1 > "${ROOTFS_DIR}/var/lib/systemd/rfkill/platform-fe300000.mmcnr:wlan"
- -fi
diff --git a/stage2/02-net-tweaks/files/wait.conf b/stage2/02-net-tweaks/files/wait.conf
deleted file mode 100644
index 595cc2d..0000000
- --- a/stage2/02-net-tweaks/files/wait.conf
+++ /dev/null
@@ -1,3 +0,0 @@
- -[Service]
- -ExecStart=
- -ExecStart=/usr/lib/dhcpcd5/dhcpcd -q -w
diff --git a/stage2/02-net-tweaks/files/wpa_supplicant.conf b/stage2/02-net-tweaks/files/wpa_supplicant.conf
deleted file mode 100644
index 0fc335e..0000000
- --- a/stage2/02-net-tweaks/files/wpa_supplicant.conf
+++ /dev/null
@@ -1,2 +0,0 @@
- -ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
- -update_config=1
diff --git a/stage3/00-gpg/00-packages b/stage3/00-gpg/00-packages
new file mode 100644
index 0000000..37ca8be
- --- /dev/null
+++ b/stage3/00-gpg/00-packages
@@ -0,0 +1 @@
+gpg
diff --git a/stage3/00-install-packages/00-debconf b/stage3/00-install-packages/00-debconf
deleted file mode 100644
index 7dbd12e..0000000
- --- a/stage3/00-install-packages/00-debconf
+++ /dev/null
@@ -1,2 +0,0 @@
- -# Adobe Flash Player. Copyright 1996-2015. Adobe Systems Incorporated. All Rights Reserved.
- -rpi-chromium-mods	rpi-chromium-mods/adobe	note
diff --git a/stage3/00-install-packages/00-packages b/stage3/00-install-packages/00-packages
deleted file mode 100644
index eac74ea..0000000
- --- a/stage3/00-install-packages/00-packages
+++ /dev/null
@@ -1,15 +0,0 @@
- -gstreamer1.0-x gstreamer1.0-omx gstreamer1.0-plugins-base gstreamer1.0-plugins-good gstreamer1.0-plugins-bad gstreamer1.0-alsa gstreamer1.0-libav
- -qpdfview gtk2-engines alsa-utils
- -desktop-base
- -git
- -omxplayer
- -raspberrypi-artwork
- -policykit-1
- -gvfs
- -rfkill
- -chromium-browser rpi-chromium-mods
- -gldriver-test
- -fonts-droid-fallback
- -fonts-liberation2
- -obconf
- -arandr
diff --git a/stage3/00-install-packages/00-packages-nr b/stage3/00-install-packages/00-packages-nr
deleted file mode 100644
index ffc324b..0000000
- --- a/stage3/00-install-packages/00-packages-nr
+++ /dev/null
@@ -1,6 +0,0 @@
- -xserver-xorg-video-fbdev xserver-xorg xinit xserver-xorg-video-fbturbo
- -mousepad
- -lxde lxtask menu-xdg
- -zenity xdg-utils
- -gvfs-backends gvfs-fuse
- -lightdm gnome-themes-standard-data gnome-icon-theme
diff --git a/stage3/00-install-packages/01-run.sh b/stage3/00-install-packages/01-run.sh
deleted file mode 100755
index d768747..0000000
- --- a/stage3/00-install-packages/01-run.sh
+++ /dev/null
@@ -1,8 +0,0 @@
- -#!/bin/bash -e
- -
- -on_chroot << EOF
- -update-alternatives --install /usr/bin/x-www-browser \
- -  x-www-browser /usr/bin/chromium-browser 86
- -update-alternatives --install /usr/bin/gnome-www-browser \
- -  gnome-www-browser /usr/bin/chromium-browser 86
- -EOF
diff --git a/stage3/01-smartcard/00-packages b/stage3/01-smartcard/00-packages
new file mode 100644
index 0000000..2b9108b
- --- /dev/null
+++ b/stage3/01-smartcard/00-packages
@@ -0,0 +1,2 @@
+scdaemon
+pcscd pcsc-tools
diff --git a/stage3/01-tweaks/00-run.sh b/stage3/01-tweaks/00-run.sh
deleted file mode 100755
index 5da7c1a..0000000
- --- a/stage3/01-tweaks/00-run.sh
+++ /dev/null
@@ -1,3 +0,0 @@
- -#!/bin/bash -e
- -
- -rm -f "${ROOTFS_DIR}/etc/systemd/system/dhcpcd.service.d/wait.conf"
diff --git a/stage3/02-ykman/00-packages b/stage3/02-ykman/00-packages
new file mode 100644
index 0000000..6a797f5
- --- /dev/null
+++ b/stage3/02-ykman/00-packages
@@ -0,0 +1,4 @@
+swig
+libu2f-udev
+pcscd libpcsclite-dev
+python3 python3-pip
diff --git a/stage3/02-ykman/02-run.sh b/stage3/02-ykman/02-run.sh
new file mode 100755
index 0000000..0ddef3a
- --- /dev/null
+++ b/stage3/02-ykman/02-run.sh
@@ -0,0 +1,84 @@
+#!/bin/bash
+
+source files/common
+
+BUILDERFS_DIR="${ROOTFS_DIR}.builder"
+
+prepare_builder
+
+# Install build tools and dependencies
+on_builder << EOF
+apt update
+apt install -y \
+    git \
+    python3 python3-dev python3-pip python3-pkg-resources \
+    rustc rust-gdb \
+    cargo \
+    build-essential \
+    libssl-dev \
+    libffi-dev \
+    zlib1g-dev \
+    upx-ucl \
+    swig \
+    libu2f-udev \
+    pcscd libpcsclite-dev
+python3 -m pip install --upgrade pip
+
+pip install poetry
+pip install pytest
+pip install pyinstaller
+EOF
+
+# Clone YubiKey Manager
+on_builder << EOF
+git clone https://github.com/yubico/yubikey-manager
+cd yubikey-manager
+
+# Checkout specified tag
+git checkout ${YKMAN_TAG}
+EOF
+
+# Install ykman dependencies
+on_builder << EOF
+cd yubikey-manager
+
+CARGO_NET_GIT_FETCH_WITH_CLI=true poetry install
+EOF
+
+# Unit test
+on_builder << EOF
+cd yubikey-manager
+
+poetry run pytest
+
+echo -n "ykman version: "
+poetry run ykman --version
+EOF
+
+# Install ykman locally
+on_builder << EOF
+cd yubikey-manager
+
+pip install .
+
+echo -n "ykman location: "
+which ykman
+
+echo -n "ykman version: "
+ykman --version
+EOF
+
+# Build ykman binary
+on_builder << EOF
+cd yubikey-manager
+
+pyinstaller ykman.spec
+
+echo -n "ykman version: "
+dist/ykman --version
+EOF
+
+# Install YubiKey Manager binary
+install -m 755 "${BUILDERFS_DIR}/yubikey-manager/dist/ykman" "${ROOTFS_DIR}/usr/bin"
+
+echo "YKMAN VERSION => $YKMAN_TAG"
diff --git a/stage3/02-ykman/files/common b/stage3/02-ykman/files/common
new file mode 100644
index 0000000..5ba4166
- --- /dev/null
+++ b/stage3/02-ykman/files/common
@@ -0,0 +1,30 @@
+prepare_builder(){
+    if [ ! -d "${ROOTFS_DIR}" ]; then
+        echo "rootfs not found"
+        false
+    fi
+    mkdir -p "${BUILDERFS_DIR}"
+    rsync -aHAXx --exclude var/cache/apt/archives "${ROOTFS_DIR}/" "${BUILDERFS_DIR}/"
+}
+export -f prepare_builder
+
+on_builder() {
+	if ! mount | grep -q "$(realpath "${BUILDERFS_DIR}"/proc)"; then
+		mount -t proc proc "${BUILDERFS_DIR}/proc"
+	fi
+
+	if ! mount | grep -q "$(realpath "${BUILDERFS_DIR}"/dev)"; then
+		mount --bind /dev "${BUILDERFS_DIR}/dev"
+	fi
+
+	if ! mount | grep -q "$(realpath "${BUILDERFS_DIR}"/dev/pts)"; then
+		mount --bind /dev/pts "${BUILDERFS_DIR}/dev/pts"
+	fi
+
+	if ! mount | grep -q "$(realpath "${BUILDERFS_DIR}"/sys)"; then
+		mount --bind /sys "${BUILDERFS_DIR}/sys"
+	fi
+
+	setarch linux32 capsh --drop=cap_setfcap "--chroot=${BUILDERFS_DIR}/" -- -e "$@"
+}
+export -f on_builder
diff --git a/stage3/EXPORT_IMAGE b/stage3/EXPORT_IMAGE
new file mode 100644
index 0000000..fef3af3
- --- /dev/null
+++ b/stage3/EXPORT_IMAGE
@@ -0,0 +1,4 @@
+IMG_SUFFIX="-airgapi"
+if [ "${USE_QEMU}" = "1" ]; then
+    export IMG_SUFFIX="${IMG_SUFFIX}-qemu"
+fi
- -- 
2.33.0


- From eaebcbbaba537ed0a463c0e8316ab19a10519b39 Mon Sep 17 00:00:00 2001
From: GHIFARI160 <ghifari@ghifari160.com>
Date: Sat, 16 Oct 2021 18:05:52 -0500
Subject: Implement read-only boot and overlay root

Exclude rsyslog and logrotate from debootstrap. The target file system
will not be writable.

Add commented out initramfs boot config. Let the Pi boot normally on
first boot. The init script will uncomment this config line.

Mount tmpfs to /tmp, /var/log, /var/tmp, and /var/lib/dhcp. Certain
software expect these directories to be writable.

Add no-install-recommends flag to raspi-config installation. Only the
bare minimum is necessary.

Add resolvconf installation. /etc/resolv.conf might not be writable. Use
resolvconf package instead.

Remove swap patch. Swap require a writable file system, which might not
be present.

Add init_resize4ro.sh script to resize init patch. This script handles
the resizing of root fs and prepares the environment for initramfs
creation.

Install init_resize4ro.sh and resize2fs4ro.sh to root fs. These scripts
initializes this image.

Implement init_resize4ro.sh. Resize the root fs. Set resize2fs4ro.sh as
boot init script. Remount /boot as readonly. Reboot.

Implement overlay script. Override initramfs-tools local_mount_root.
Mount tmpfs to /ovlfs. Mount root fs as readonly to /ovlfs/root. Remount
root fs as writable overlay to ${rootmnt}. Recursively bind /ovlfs to
${rootmnt}/ovlfs. Patch fstab mount root fs as writable overlay.

Implement resize2fs4ro.sh. Remount boot device as writable. Create
initramfs. Resize root fs. Remove boot init script. Enable fastboot and
disable swap. Enable initramfs boot. Set boot mode to overlay. Patch
fstab to mount root fs as readonly for overlay failure fallback.
Regenerate SSH host keys. Remove init scripts. Remount root fs as
readonly. Reboot.

Delete resize2fs_once. resize2fs4ro.sh replaces this init script.

Install busybox-syslogd and rfkill. Let busybox log to syslog.

Remove substage 03-accept-mathematica-eula. The package will not be
installed in this image.

Remove substage EXPORT_NOOBS. NOOBS is not a supported deployment for
this image.
- ---
 scripts/common                                |   4 +-
 stage1/00-boot-files/files/config.txt         |   3 +
 stage1/01-sys-tweaks/files/fstab              |   4 +
 stage1/03-install-packages/00-packages        |   2 +-
 stage1/03-install-packages/00-packages-nr     |   1 +
 stage2/01-sys-tweaks/00-packages              |   2 +-
 stage2/01-sys-tweaks/00-patches/02-swap.diff  |  13 --
 .../00-patches/07-resize-init.diff            |   2 +-
 stage2/01-sys-tweaks/00-patches/series        |   1 -
 stage2/01-sys-tweaks/01-run.sh                |  25 ++-
 stage2/01-sys-tweaks/files/init_resize4ro.sh  | 174 ++++++++++++++++++
 stage2/01-sys-tweaks/files/overlay            |  51 +++++
 stage2/01-sys-tweaks/files/resize2fs4ro.sh    |  52 ++++++
 stage2/01-sys-tweaks/files/resize2fs_once     |  25 ---
 .../files/systemd-timesyncd.service           |   0
 stage2/02-net-tweaks/00-packages              |   2 +
 stage2/03-accept-mathematica-eula/00-debconf  |   2 -
 stage2/EXPORT_NOOBS                           |   2 -
 18 files changed, 308 insertions(+), 57 deletions(-)
 create mode 100644 stage1/03-install-packages/00-packages-nr
 delete mode 100644 stage2/01-sys-tweaks/00-patches/02-swap.diff
 create mode 100755 stage2/01-sys-tweaks/files/init_resize4ro.sh
 create mode 100755 stage2/01-sys-tweaks/files/overlay
 create mode 100755 stage2/01-sys-tweaks/files/resize2fs4ro.sh
 delete mode 100644 stage2/01-sys-tweaks/files/resize2fs_once
 create mode 100644 stage2/01-sys-tweaks/files/systemd-timesyncd.service
 delete mode 100644 stage2/03-accept-mathematica-eula/00-debconf
 delete mode 100644 stage2/EXPORT_NOOBS

diff --git a/scripts/common b/scripts/common
index e2048d9..cc76e62 100644
- --- a/scripts/common
+++ b/scripts/common
@@ -5,7 +5,7 @@ export -f log
 
 bootstrap(){
 	local BOOTSTRAP_CMD=debootstrap
- -	local BOOTSTRAP_ARGS=()
+	local BOOTSTRAP_ARGS=(--exclude=rsyslog,logrotate --include=busybox-syslogd)
 
 	export http_proxy=${APT_PROXY}
 
@@ -81,7 +81,7 @@ on_chroot() {
 	if ! mount | grep -q "$(realpath "${ROOTFS_DIR}"/dev)"; then
 		mount --bind /dev "${ROOTFS_DIR}/dev"
 	fi
- -	
+
 	if ! mount | grep -q "$(realpath "${ROOTFS_DIR}"/dev/pts)"; then
 		mount --bind /dev/pts "${ROOTFS_DIR}/dev/pts"
 	fi
diff --git a/stage1/00-boot-files/files/config.txt b/stage1/00-boot-files/files/config.txt
index 548f4ac..ae3b2f9 100644
- --- a/stage1/00-boot-files/files/config.txt
+++ b/stage1/00-boot-files/files/config.txt
@@ -56,6 +56,9 @@
 # Enable audio (loads snd_bcm2835)
 dtparam=audio=on
 
+# uncomment to boot via initramfs
+# initramfs initrd.img-5.10.63-v71+
+
 [pi4]
 # Enable DRM VC4 V3D driver on top of the dispmanx display stack
 dtoverlay=vc4-fkms-v3d
diff --git a/stage1/01-sys-tweaks/files/fstab b/stage1/01-sys-tweaks/files/fstab
index f16e3fb..fa0d520 100644
- --- a/stage1/01-sys-tweaks/files/fstab
+++ b/stage1/01-sys-tweaks/files/fstab
@@ -1,3 +1,7 @@
 proc            /proc           proc    defaults          0       0
 BOOTDEV  /boot           vfat    defaults          0       2
 ROOTDEV  /               ext4    defaults,noatime  0       1
+tmpfs    /tmp            tmpfs   nosuid,nodev      0       0
+tmpfs    /var/log        tmpfs   nosuid,nodev      0       0
+tmpfs    /var/tmp        tmpfs   nosuid,nodev      0       0
+tmpfs    /var/lib/dhcp   tmpfs   nosuid,nodev      0       0
diff --git a/stage1/03-install-packages/00-packages b/stage1/03-install-packages/00-packages
index e8c148c..73edcc9 100644
- --- a/stage1/03-install-packages/00-packages
+++ b/stage1/03-install-packages/00-packages
@@ -1 +1 @@
- -libraspberrypi-bin libraspberrypi0 raspi-config
+libraspberrypi-bin libraspberrypi0
diff --git a/stage1/03-install-packages/00-packages-nr b/stage1/03-install-packages/00-packages-nr
new file mode 100644
index 0000000..9e91ea1
- --- /dev/null
+++ b/stage1/03-install-packages/00-packages-nr
@@ -0,0 +1 @@
+raspi-config
diff --git a/stage2/01-sys-tweaks/00-packages b/stage2/01-sys-tweaks/00-packages
index ed072cf..24e52b9 100644
- --- a/stage2/01-sys-tweaks/00-packages
+++ b/stage2/01-sys-tweaks/00-packages
@@ -10,7 +10,6 @@ hardlink ca-certificates curl
 fake-hwclock nfs-common usbutils
 libraspberrypi-dev libraspberrypi-doc libfreetype6-dev
 dosfstools
- -dphys-swapfile
 raspberrypi-sys-mods
 apt-listchanges
 usb-modeswitch
@@ -29,3 +28,4 @@ ntfs-3g
 pciutils
 rpi-eeprom
 raspinfo
+resolvconf
diff --git a/stage2/01-sys-tweaks/00-patches/02-swap.diff b/stage2/01-sys-tweaks/00-patches/02-swap.diff
deleted file mode 100644
index 745a344..0000000
- --- a/stage2/01-sys-tweaks/00-patches/02-swap.diff
+++ /dev/null
@@ -1,13 +0,0 @@
- -Index: jessie-stage2/rootfs/etc/dphys-swapfile
- -===================================================================
- ---- jessie-stage2.orig/rootfs/etc/dphys-swapfile
- -+++ jessie-stage2/rootfs/etc/dphys-swapfile
- -@@ -13,7 +13,7 @@
- - 
- - # set size to absolute value, leaving empty (default) then uses computed value
- - #   you most likely don't want this, unless you have an special disk situation
- --#CONF_SWAPSIZE=
- -+CONF_SWAPSIZE=100
- - 
- - # set size to computed value, this times RAM size, dynamically adapts,
- - #   guarantees that there is enough swap without wasting disk space on excess
diff --git a/stage2/01-sys-tweaks/00-patches/07-resize-init.diff b/stage2/01-sys-tweaks/00-patches/07-resize-init.diff
index 8c41357..5660fb8 100644
- --- a/stage2/01-sys-tweaks/00-patches/07-resize-init.diff
+++ b/stage2/01-sys-tweaks/00-patches/07-resize-init.diff
@@ -2,4 +2,4 @@
 +++ stage2/rootfs/boot/cmdline.txt
 @@ -1 +1 @@
 -console=serial0,115200 console=tty1 root=ROOTDEV rootfstype=ext4 elevator=deadline fsck.repair=yes rootwait
- -+console=serial0,115200 console=tty1 root=ROOTDEV rootfstype=ext4 elevator=deadline fsck.repair=yes rootwait quiet init=/usr/lib/raspi-config/init_resize.sh
++console=serial0,115200 console=tty1 root=ROOTDEV rootfstype=ext4 elevator=deadline fsck.repair=yes rootwait quiet init=/usr/local/sbin/init_resize4ro.sh
diff --git a/stage2/01-sys-tweaks/00-patches/series b/stage2/01-sys-tweaks/00-patches/series
index aee0402..c5d8e4b 100644
- --- a/stage2/01-sys-tweaks/00-patches/series
+++ b/stage2/01-sys-tweaks/00-patches/series
@@ -1,5 +1,4 @@
 01-useradd.diff
- -02-swap.diff
 04-inputrc.diff
 05-path.diff
 07-resize-init.diff
diff --git a/stage2/01-sys-tweaks/01-run.sh b/stage2/01-sys-tweaks/01-run.sh
index c1836f9..12e7aa4 100755
- --- a/stage2/01-sys-tweaks/01-run.sh
+++ b/stage2/01-sys-tweaks/01-run.sh
@@ -1,6 +1,8 @@
 #!/bin/bash -e
 
- -install -m 755 files/resize2fs_once	"${ROOTFS_DIR}/etc/init.d/"
+# readonly root image
+install -m 755 files/init_resize4ro.sh "${ROOTFS_DIR}/usr/local/sbin"
+install -m 755 files/resize2fs4ro.sh   "${ROOTFS_DIR}/usr/local/sbin"
 
 install -d				"${ROOTFS_DIR}/etc/systemd/system/rc-local.service.d"
 install -m 644 files/ttyoutput.conf	"${ROOTFS_DIR}/etc/systemd/system/rc-local.service.d/"
@@ -32,20 +34,12 @@ if [ "${ENABLE_SSH}" == "1" ]; then
 else
 	systemctl disable ssh
 fi
- -systemctl enable regenerate_ssh_host_keys
 EOF
 
 if [ "${USE_QEMU}" = "1" ]; then
 	echo "enter QEMU mode"
 	install -m 644 files/90-qemu.rules "${ROOTFS_DIR}/etc/udev/rules.d/"
- -	on_chroot << EOF
- -systemctl disable resize2fs_once
- -EOF
 	echo "leaving QEMU mode"
- -else
- -	on_chroot << EOF
- -systemctl enable resize2fs_once
- -EOF
 fi
 
 on_chroot <<EOF
@@ -66,3 +60,16 @@ usermod --pass='*' root
 EOF
 
 rm -f "${ROOTFS_DIR}/etc/ssh/"ssh_host_*_key*
+
+# Readonly image
+echo "ROOTFS_DIR:"
+ls -l "${ROOTFS_DIR}/etc/"
+cp files/overlay "${ROOTFS_DIR}/etc/initramfs-tools/scripts/"
+
+on_chroot << EOF
+	mkdir /etc/systemd/system/systemd-random-seed.service.d
+	echo -e '[Service]\nExecStartPre=/bin/echo "" > /tmp/random-seed' > /etc/systemd/system/systemd-random-seed.service.d/readonly.conf
+	ln -s /tmp/random-seed /var/lib/systemd/random-seed
+	rm -f /etc/resolv.conf
+	ln -sf /run/resolvconf/resolv.conf /etc/resolv.conf
+EOF
diff --git a/stage2/01-sys-tweaks/files/init_resize4ro.sh b/stage2/01-sys-tweaks/files/init_resize4ro.sh
new file mode 100755
index 0000000..b001fae
- --- /dev/null
+++ b/stage2/01-sys-tweaks/files/init_resize4ro.sh
@@ -0,0 +1,174 @@
+#!/bin/sh
+
+reboot_pi () {
+    umount /boot
+    mount / -o remount,ro
+    sync
+
+    echo b > /proc/sysrq-trigger
+
+    sleep 5
+    exit 0
+}
+
+check_commands () {
+    if ! command -v whiptail > /dev/null; then
+        echo "whiptail not found"
+        sleep 5
+        return 1
+    fi
+
+    for COMMAND in grep cut sed parted fdisk findmnt; do
+        if ! command -v $COMMAND > /dev/null; then
+            FAIL_REASON="$COMMAND not found"
+            return 1
+        fi
+    done
+    return 0
+}
+
+get_variables () {
+    ROOT_PART_DEV=$(findmnt / -o source -n)
+    ROOT_PART_NAME=$(echo "$ROOT_PART_DEV" | cut -d "/" -f 3)
+    ROOT_DEV_NAME=$(echo /sys/block/*/"${ROOT_PART_NAME}" | cut -d "/" -f 4)
+    ROOT_DEV="/dev/${ROOT_DEV_NAME}"
+    ROOT_PART_NUM=$(cat "/sys/block/${ROOT_DEV_NAME}/${ROOT_PART_NAME}/partition")
+
+    BOOT_PART_DEV=$(findmnt /boot -o source -n)
+    BOOT_PART_NAME=$(echo "$BOOT_PART_DEV" | cut -d "/" -f 3)
+    BOOT_DEV_NAME=$(echo /sys/block/*/"${BOOT_PART_NAME}" | cut -d "/" -f 4)
+    BOOT_PART_NUM=$(cat "/sys/block/${BOOT_DEV_NAME}/${BOOT_PART_NAME}/partition")
+
+    OLD_DISKID=$(fdisk -l "$ROOT_DEV" | sed -n 's/Disk identifier: 0x\([^ ]*\)/\1/p')
+
+    ROOT_DEV_SIZE=$(cat "/sys/block/${ROOT_DEV_NAME}/size")
+    TARGET_END=$((ROOT_DEV_SIZE - 1))
+
+    PARTITION_TABLE=$(parted -m "$ROOT_DEV" unit s print | tr -d 's')
+
+    LAST_PART_NUM=$(echo "$PARTITION_TABLE" | tail -n 1 | cut -d ":" -f 1)
+
+    ROOT_PART_LINE=$(echo "$PARTITION_TABLE" | grep -e "^${ROOT_PART_NUM}:")
+    ROOT_PART_START=$(echo "$ROOT_PART_LINE" | cut -d ":" -f 2)
+    ROOT_PART_END=$(echo "$ROOT_PART_LINE" | cut -d ":" -f 3)
+}
+
+fix_partuuid() {
+    mount -o remount,rw "$ROOT_PART_DEV"
+    mount -o remount,rw "$BOOT_PART_DEV"
+    DISKID="$(tr -dc 'a-f0-9' < /dev/hwrng | dd bs=1 count=8 2>/dev/null)"
+    fdisk "$ROOT_DEV" > /dev/null <<EOF
+x
+i
+0x$DISKID
+r
+w
+EOF
+
+    if [ "$?" -eq 0 ]; then
+        sed -i "s/${OLD_DISKID}/${DISKID}/g" /etc/fstab
+        sed -i "s/${OLD_DISKID}/${DISKID}/" /boot/cmdline.txt
+        sync
+    fi
+
+    mount -o remount,ro "$ROOT_PART_DEV"
+    mount -o remount,ro "$BOOT_PART_DEV"
+}
+
+check_variables() {
+    if [ "$BOOT_DEV_NAME" != "$ROOT_DEV_NAME" ]; then
+        FAIL_REASON="Boot and root partitions are on different devices"
+        return 1
+    fi
+
+    if [ "$ROOT_PART_NUM" -ne "$LAST_PART_NUM" ]; then
+        FAIL_REASON="Root partition should be last partition"
+        return 1
+    fi
+
+    if [ "$ROOT_PART_END" -gt "$TARGET_END" ]; then
+        FAIL_REASON="Root partition runs past the end of device"
+        return 1
+    fi
+
+    if [ ! -b "$ROOT_DEV" ] || [ ! -b "$ROOT_PART_DEV" ] || [ ! -b "$BOOT_PART_DEV" ]; then
+        FAIL_REASON="Could not determine partitions"
+        return 1
+    fi
+}
+
+check_kernel() {
+    MAJOR="$(uname -r | cut -f1 -d.)"
+    MINOR="$(uname -r | cut -f2 -d.)"
+
+    if [ "$MAJOR" -eq "4" ] && [ "$MINOR" -lt "9" ]; then
+        return 0
+    fi
+
+    if [ "$MAJOR" -lt "4" ]; then
+        return 0
+    fi
+
+    NEW_KERNEL=1
+}
+
+main() {
+    whiptail --infobox "Initializing AirGaPi..." 20 60
+
+    get_variables
+
+    if ! check_variables; then
+        return 1
+    fi
+
+    check_kernel
+
+    if [ "$ROOT_PART_END" -eq "$TARGET_END" ]; then
+        reboot_pi
+    fi
+
+    if ! parted -m "$ROOT_DEV" u s resizepart "$ROOT_PART_NUM" "$TARGET_END"; then
+        FAIL_REASON="Root partition resize fialed"
+        return 1
+    fi
+
+    fix_partuuid
+
+    return 0
+}
+
+echo "AirGaPi first boot initialization"
+
+mount -t proc proc /proc
+mount -t sysfs sys /sys
+mount -t tmpfs tmp /run
+mkdir -p /run/systemd
+
+mount /boot
+mount / -o remount,ro
+
+sed -i 's| init=/usr/local/sbin/init_resize4ro\.sh| init=/usr/local/sbin/resize2fs4ro.sh|' /boot/cmdline.txt
+sed -i 's| sdhci\.debug_quirks2=4||' /boot/cmdline.txt
+
+if ! grep -q splash /boot/cmdline.txt; then
+    sed -i "s/ quiet//g" /boot/cmdline.txt
+fi
+
+mount /boot -o remount,ro
+sync
+
+echo 1 > /proc/sys/kernel/sysrq
+
+if ! check_commands; then
+    reboot_pi
+fi
+
+if main; then
+    whiptail --infobox "Going to resize root filesystem. Rebooting in 5 seconds..." 20 60
+    sleep 5
+else
+    whiptail --msgbox "Could not expand filesystem. Rebooting in 5 seconds...\n${FAIL_REASON}" 20 60
+    sleep 5
+fi
+
+reboot_pi
diff --git a/stage2/01-sys-tweaks/files/overlay b/stage2/01-sys-tweaks/files/overlay
new file mode 100755
index 0000000..542d1d6
- --- /dev/null
+++ b/stage2/01-sys-tweaks/files/overlay
@@ -0,0 +1,51 @@
+# Local filesystem mounting
+
+. /scripts/local
+
+local_mount_root() {
+    local_top
+
+    if [ -z "${ROOT}" ]; then
+        panic "No root device specified. Boot arguments must include a root= parameter."
+    fi
+
+    local_device_setup "${ROOT}" "root file system"
+    ROOT="${DEV}"
+
+    # Get root fs type
+    if [ -z "${ROOTFSTYPE}" ] || [ "${ROOTFSTYPE}" = auto ]; then
+        FSTYPE=$(get_fstype "${ROOT}")
+    else
+        FSTYPE=${ROOTFSTYPE}
+    fi
+
+    local_premount
+
+    checkfs "${ROOT}" root "${FSTYPE}"
+
+    # Prepare overlay fs tree
+    mkdir /ovlfs
+
+    # Use tmpfs as overlay directory
+    mount -t tmpfs tmpfs /ovlfs
+    mkdir -p /ovlfs/data /ovlfs/work /ovlfs/root
+
+    # Mount/remount root
+    umount "${ROOT}"
+    if ! mount -r ${FSTYPE:+-t "${FSTYPE}"} ${ROOTFLAGS} "${ROOT}" "/ovlfs/root"; then
+    # if ! mount -r ${FSTYPE:+-t "${FSTYPE}"} ${ROOTFLAGS} "${ROOT}" "${rootmnt?}"; then
+        panic "Failed to mount ${ROOT} as root file system."
+    fi
+
+    # Mount root as overlay
+    mount -t overlay overlay -o lowerdir=/ovlfs/root,upperdir=/ovlfs/data,workdir=/ovlfs/work ${rootmnt?}
+
+    # Recursive bind /ovlfs to ${rootmnt}/ovlfs (initram /ovlfs -> ${rootmnt}/ovlfs)
+    mkdir -p ${rootmnt?}/ovlfs
+    mount -n -o rbind /ovlfs ${rootmnt?}/ovlfs
+
+    # Fix fstab
+    sed -i \
+        -e 's|PARTUUID=\([a-f0-9\-]\{11\}\)\([[:space:]].*\)/\([[:space:]].*\)ext4\([[:space:]].*\)defaults,ro,noatime|overlay\2/\3overlay\4noauto,x-systemd.automount,lowerdir='/ovlfs/root',upperdir='/ovlfs/upper',workdir='/ovlfs/work'|g' \
+        ${rootmnt?}/etc/fstab
+}
diff --git a/stage2/01-sys-tweaks/files/resize2fs4ro.sh b/stage2/01-sys-tweaks/files/resize2fs4ro.sh
new file mode 100755
index 0000000..b916355
- --- /dev/null
+++ b/stage2/01-sys-tweaks/files/resize2fs4ro.sh
@@ -0,0 +1,52 @@
+#!/bin/bash
+
+mount -t proc none /proc
+
+# TODO: configurable USB vs microSD boot. USB boots from /dev/sdaX. Probably /dev/sda1 for /boot and /dev/sda2 for /
+mount -o remount,rw /dev/mmcblk0p2 /
+mount /dev/mmcblk0p1 /boot
+
+echo "AirGaPi: creating initramfs:"
+echo overlay > /etc/initramfs-tools/modules
+update-initramfs -c -k $(uname -r) 2>/dev/null > /dev/null
+echo "AirGaPi: done."
+
+echo "AirGaPi: resizing root filesystem"
+resize2fs /dev/mmcblk0p2
+echo "AirGaPi: done."
+
+echo -n "AirGaPi: setting /boot/cmdline.txt to ro mode..."
+sed -i -e 's/ init=[^ ]\+//g' -e 's/rootwait/rootwait fastboot noswap ro/g' /boot/cmdline.txt
+echo "done."
+
+initramfs=$(basename /boot/initrd.img-*)
+
+echo -n "AirGaPi: enabling initramfs for overlayfs..."
+sed -i -e "s/^ *# *initramfs.*/initramfs $initramfs/g" /boot/config.txt
+sed -i -e 's/^/boot=overlay /g' /boot/cmdline.txt
+echo "done."
+
+echo -n "AirGaPi: setting /etc/fstab to ro mode..."
+sed -i -e 's|\([[:space:]]/[[:space:]].*\)defaults|\1defaults,ro|g' -e 's|\([[:space:]]/boot[[:space:]].*\)defaults|\1defaults,ro|g' /etc/fstab
+echo "done."
+
+# Regenerate SSH keys
+dd if=/dev/hwrng of=/dev/urandom count=1 bs=4096
+rm -f -v /etc/ssh/ssh_host_*_key*
+ssh-keygen -A -v
+
+# Clean up
+rm -f /usr/local/sbin/init_resize4ro.sh
+rm -f /usr/local/sbin/resize2fs4ro.sh
+
+echo -n "AirGaPi: rebooting into readonly mode..."
+
+umount /boot
+mount -o remount,ro /dev/mmcblk0p2 /
+sync
+
+echo b > /proc/sysrq-trigger
+
+echo "done."
+sleep 5
+exit 0
diff --git a/stage2/01-sys-tweaks/files/resize2fs_once b/stage2/01-sys-tweaks/files/resize2fs_once
deleted file mode 100644
index 38a4d47..0000000
- --- a/stage2/01-sys-tweaks/files/resize2fs_once
+++ /dev/null
@@ -1,25 +0,0 @@
- -#!/bin/sh
- -### BEGIN INIT INFO
- -# Provides:          resize2fs_once
- -# Required-Start:
- -# Required-Stop:
- -# Default-Start: 3
- -# Default-Stop:
- -# Short-Description: Resize the root filesystem to fill partition
- -# Description:
- -### END INIT INFO
- -. /lib/lsb/init-functions
- -case "$1" in
- -  start)
- -    log_daemon_msg "Starting resize2fs_once"
- -    ROOT_DEV=$(findmnt / -o source -n) &&
- -    resize2fs $ROOT_DEV &&
- -    update-rc.d resize2fs_once remove &&
- -    rm /etc/init.d/resize2fs_once &&
- -    log_end_msg $?
- -    ;;
- -  *)
- -    echo "Usage: $0 start" >&2
- -    exit 3
- -    ;;
- -esac
diff --git a/stage2/01-sys-tweaks/files/systemd-timesyncd.service b/stage2/01-sys-tweaks/files/systemd-timesyncd.service
new file mode 100644
index 0000000..e69de29
diff --git a/stage2/02-net-tweaks/00-packages b/stage2/02-net-tweaks/00-packages
index 434335a..08a8755 100644
- --- a/stage2/02-net-tweaks/00-packages
+++ b/stage2/02-net-tweaks/00-packages
@@ -1 +1,3 @@
 net-tools
+busybox-syslogd
+rfkill
diff --git a/stage2/03-accept-mathematica-eula/00-debconf b/stage2/03-accept-mathematica-eula/00-debconf
deleted file mode 100644
index d9743fe..0000000
- --- a/stage2/03-accept-mathematica-eula/00-debconf
+++ /dev/null
@@ -1,2 +0,0 @@
- -# Do you accept the Wolfram - Raspberry PiÂ® Bundle License Agreement?
- -wolfram-engine  shared/accepted-wolfram-eula    boolean true
diff --git a/stage2/EXPORT_NOOBS b/stage2/EXPORT_NOOBS
deleted file mode 100644
index 0d78ecf..0000000
- --- a/stage2/EXPORT_NOOBS
+++ /dev/null
@@ -1,2 +0,0 @@
- -NOOBS_NAME="Raspberry Pi OS Lite (32-bit)"
- -NOOBS_DESCRIPTION="A port of Debian with no desktop environment"
- -- 
2.33.0

-----BEGIN PGP SIGNATURE-----

iQIzBAEBCAAdFiEEewc3Mx682TYvUr0IlsuB1cBFb4QFAmFrZIYACgkQlsuB1cBF
b4QB/RAAlim9rAAaqnrEf6CVgeTkoMMOWCTaRnfDce+DKbtITVeBXNIrpfOpczyu
mXQQ4XleMG16FTx2Bm3ujpHmMzVhFd+bX9o0ZBfifEa3FCnD3BQArnDUQPqHQPrp
LsEinzzn+kNNP9guDuzqqjr0DC+SrhfbLDdPUHgscaPEP2WmO1gzWROUqrO1cQVI
H7MO9AwgSpiWfdS/SruXseQjPLy3dCK+IlQ3xlYPTLWe4Q4TJNOek7/A+ysbh793
K81IuRaOmP8bcVRQKgzkw4e8RpOHpajKR4V3RWLsVHV+sclCet/xVjkIag1h3fGp
xydpgOHwpmnyFCdnzbcTVDMGPUw+SUwftvNPHf5b2PAcdtOP+KjprJID7czuvNpG
RWUIVzuxIJ4qPZyd4IoWr71xlYRFtGkqmHZ09oNPzhpOABUTrDpJr3b9Zx3JDLdI
4PqKWy0bBd6Q/QYspdAXmKcqMWB3l46gCQtHOZZXTiivpmIhLv2VmZeIZ+GirmkF
pUusghJMnJzbzCrFRCn5/14nLk7VHHexyGHvn7tlsfRzLmrS6dGSayjE4gAEzCU9
5BOsjOwdz2wWZ6mu2FeJ+eyaQ5X149tHk6TC3yB2sH6Sp9OMKUr8/NXl+Q0oAUj5
EK149yxkoXyDIazBXq6lDjzXlJZuZQzjNvbR95ZtMYUQQzS5+UM=
=WIY0
-----END PGP SIGNATURE-----
